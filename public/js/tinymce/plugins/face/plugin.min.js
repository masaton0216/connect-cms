tinymce.PluginManager.add('face', function(editor, url) {
    // アイコン
    editor.ui.registry.addIcon('face', '<img src="'+tinymce.activeEditor.getParam('document_base_url')+'/js/tinymce/plugins/face/icon_face.png" />');

    // プラグインボタンの追加
    // see) https://www.tiny.cloud/docs/advanced/creating-a-plugin/
    editor.ui.registry.addButton("face", {
        icon: "face",
        tooltip: "AI顔認識",
        onAction: pluginWin,

        onPostRender: function() { // プラグイン要素選択時プラグインボタンアクティブ
            var _this = this;
            editor.on("NodeChange", function(e) {
                var is_active = jQuery( editor.selection.getNode() ).hasClass("plugin");
                _this.active( is_active );
            })

            editor.on("DblClick", function(e) {
                if ( e.target.className == "plugin" ) {
                    pluginWin(e.toElement.innerText);
                }
            })
        },
    });

    function pluginWin(e) { // プラグインウィンドウを開く関数
        tinymce.activeEditor.windowManager.open({
            title: "AI顔認識",
            body: {
                type: 'panel',
                items: [
                    {
                        // see) https://www.tiny.cloud/docs/ui-components/dialogcomponents/#alertbanner
                        type: 'alertbanner',
                        level: 'info',
                        text: '写真の顔をAIで判断して、モザイク処理を施します。',
                        icon: 'info',
                    },
                    {
                        // see) https://www.tiny.cloud/docs/ui-components/dialogcomponents/#urlinput
                        type: "urlinput",
                        name: "photo",
                        filetype: 'file', // allow any file types
                        label: 'jpg, png 形式の画像ファイル'
                    },
                        // アップロードできる最大サイズのキャプション
                    {
                        type: 'collection',
                        name: 'upload_max_filesize_caption', // identifier
                        label: editor.settings.cc_config.upload_max_filesize_caption
                    },
                    {
                        // 代替テキスト
                        type: 'input',
                        name: 'alt',
                        inputMode: 'text',
                        label: '代替テキスト',
                        placeholder: '',
                        disabled: false,
                        maximized: false
                    },
                    {
                        type: 'listbox',
                        name: 'image_size', // identifier
                        label: '画像サイズ（最大でこの大きさに縮小されます）',
                        disabled: false,
                        items: editor.settings.cc_config.face_image_sizes
                    },
                    {
                        type: 'listbox',
                        name: 'mosaic_fineness', // identifier
                        label: 'モザイクの粗さ',
                        disabled: false,
                        items: editor.settings.cc_config.finenesses
                    }
                ]
            },
            // 初期値設定
            initialData: {
                image_size:editor.settings.cc_config.face_image_initial,
                mosaic_fineness:editor.settings.cc_config.fineness_initial
            },
            buttons: [
                {
                    type: 'cancel',
                    text: 'Close'
                },
                {
                    type: 'submit',
                    text: 'Save',
                    primary: true
                }
            ],
            // OKボタンをクリックした際の挙動
            onSubmit: function(api) {

                // AJAX
                xhr = new XMLHttpRequest();
                xhr.withCredentials = false;
                xhr.open('POST', tinymce.activeEditor.getParam('document_base_url') + '/upload/face');

                xhr.onload = function() {
                    var json;

                    if (xhr.status < 200 || xhr.status >= 300) {
                        // コンソールのエラー出力
                        console.error('HTTP Error: ' + xhr.status);
                        return;
                    }

                    // jsonエラーは、JSON.parse()で発生するため、特別処理を入れる必要なし
                    json = JSON.parse(xhr.responseText);
                    // console.log(json);
                    // console.log(json.link_text);

                    // 何もアップロードしないと json = [] で返ってくるため対応
                    if (typeof json.link_text !== "undefined") {
                        // サーバから戻ってきたHTMLをエディタ画面に挿入する。
                        editor.insertContent(json.link_text);
                    }

                    // １画面に複数ウィジウィグがあるプラグイン(blog, database)のために、ここでクリア
                    document.getElementById('cc-face-upload-' + frame_id).value = '';

                    // 閉じる
                    api.close();
                };

                var tokens = document.getElementsByName("csrf-token");
                var page_id = document.getElementsByName("_page_id");
                var data = api.getData();

                // var frame_id = document.getElementsByName("frame_id")[0].value;
                var frame_id = editor.settings.cc_config.frame_id;

                formData = new FormData();
                formData.append('_token', tokens[0].content);
                formData.append('page_id', page_id[0].content);
                formData.append('plugin_name', editor.settings.cc_config.plugin_name);
                // tinymce5で input type fileが無くなったため、wysiwyg.blade.phpに用意した非表示のinput type fileを使って送信
                formData.append('photo', document.getElementById('cc-face-upload-' + frame_id).files[0]);
                formData.append('alt', data.alt);
                formData.append('image_size', data.image_size);
                formData.append('mosaic_fineness', data.mosaic_fineness);

                xhr.send(formData);
            }
        });
    } // function pluginWin()
});
