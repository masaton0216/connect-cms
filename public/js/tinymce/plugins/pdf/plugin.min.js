tinymce.PluginManager.add('pdf', function(editor, url) {
    // アイコン
    editor.ui.registry.addIcon('pdf', '<img src="'+tinymce.activeEditor.getParam('document_base_url')+'/js/tinymce/plugins/pdf/icon_pdf.png" />');

    // プラグインボタンの追加
    // see) https://www.tiny.cloud/docs/advanced/creating-a-plugin/
    editor.ui.registry.addButton("pdf", {
        icon: "pdf",
        tooltip: "PDFアップロード",
        onAction: pluginWin,

        onPostRender: function() { // プラグイン要素選択時プラグインボタンアクティブ
            var _this = this;
            editor.on("NodeChange", function(e) {
                var is_active = jQuery( editor.selection.getNode() ).hasClass("plugin");
                _this.active( is_active );
            })

            editor.on("DblClick", function(e) {
                if ( e.target.className == "plugin" ) {
                    pluginWin(e.toElement.innerText);
                }
            })
        },
    });

    function pluginWin(e) { // プラグインウィンドウを開く関数
        tinymce.activeEditor.windowManager.open({
            title: "PDFアップロード",
            body: {
                type: 'panel',
                items: [
                    {
                        // see) https://www.tiny.cloud/docs/ui-components/dialogcomponents/#alertbanner
                        type: 'alertbanner',
                        level: 'info',
                        text: 'PDFからサムネイル画像を自動作成します。',
                        icon: 'info',
                    },
                    {
                        // see) https://www.tiny.cloud/docs/ui-components/dialogcomponents/#urlinput
                        type: "urlinput",
                        name: "pdf",
                        filetype: 'file', // allow any file types
                        label: 'PDF'
                    },
                    // アップロードできる最大サイズのキャプション
                    {
                        type: 'collection',
                        name: 'upload_max_filesize_caption', // identifier
                        label: editor.settings.cc_config.upload_max_filesize_caption
                    },
                    {
                        type: 'listbox',
                        name: 'width_of_pdf_thumbnails', // identifier
                        label: 'サムネイルの大きさ',
                        disabled: false,
                        items: editor.settings.cc_config.width_of_pdf_thumbnails_items,
                    },
                    {
                        // see) https://www.tiny.cloud/docs/ui-components/dialogcomponents/#listbox
                        type: 'listbox',
                        name: 'number_of_pdf_thumbnails', // identifier
                        label: 'サムネイルの数',
                        disabled: false,
                        items: editor.settings.cc_config.number_of_pdf_thumbnails_items,
                    },
                    {
                        // see) https://www.tiny.cloud/docs/ui-components/dialogcomponents/#input
                        type: 'input',
                        name: 'pdf_password',
                        inputMode: 'text',
                        label: 'PDFパスワード',
                        placeholder: '',
                        disabled: false,
                        maximized: false
                    },
                    {
                        type: 'collection',
                        name: 'pdf_password_caption', // identifier
                        label: '※ パスワード付PDFの場合、入力してください。'
                    }
                ]
            },
            // 初期値設定
            initialData: {
                width_of_pdf_thumbnails: editor.settings.cc_config.width_of_pdf_thumbnails_initial,
                number_of_pdf_thumbnails: editor.settings.cc_config.number_of_pdf_thumbnails_initial,
            },
            buttons: [
                {
                    type: 'cancel',
                    text: 'Close'
                },
                {
                    type: 'submit',
                    text: 'Save',
                    primary: true
                }
            ],
            // OKボタンをクリックした際の挙動
            onSubmit: function(api) {
                // AJAX
                xhr = new XMLHttpRequest();
                xhr.withCredentials = false;
                xhr.open('POST', tinymce.activeEditor.getParam('document_base_url') + '/upload');

                xhr.onload = function() {
                    var json;

                    if (xhr.status < 200 || xhr.status >= 300) {
                        // コンソールのエラー出力
                        console.error('HTTP Error: ' + xhr.status);
                        return;
                    }

                    // jsonエラーは、JSON.parse()で発生するため、特別処理を入れる必要なし
                    json = JSON.parse(xhr.responseText);
                    // console.log(json);
                    // console.log(json.link_text);

                    // 何もアップロードしないと json = [] で返ってくるため対応
                    if (typeof json.link_text !== "undefined") {
                        // サーバから戻ってきたHTMLをエディタ画面に挿入する。
                        editor.insertContent(json.link_text);
                    }

                    // １画面に複数ウィジウィグがあるプラグイン(blog, database)のために、ここでクリア
                    document.getElementById('cc-pdf-upload-' + frame_id).value = '';

                    // 閉じる
                    api.close();
                };

                var tokens = document.getElementsByName("csrf-token");
                var page_id = document.getElementsByName("_page_id");
                var data = api.getData();

                // var frame_id = document.getElementsByName("frame_id")[0].value;
                var frame_id = editor.settings.cc_config.frame_id;

                formData = new FormData();
                formData.append('_token', tokens[0].content);
                formData.append('page_id', page_id[0].content);
                formData.append('plugin_name', editor.settings.cc_config.plugin_name);
                // tinymce5で input type fileが無くなったため、wysiwyg.blade.phpに用意した非表示のinput type fileを使って送信
                formData.append('pdf', document.getElementById('cc-pdf-upload-' + frame_id).files[0]);
                formData.append('pdf_password', data.pdf_password);
                formData.append('width_of_pdf_thumbnails', data.width_of_pdf_thumbnails);
                formData.append('number_of_pdf_thumbnails', data.number_of_pdf_thumbnails);

                // console.log(document.getElementById('cc-pdf-upload-' + frame_id).files.length);

                xhr.send(formData);
            }
        });
    } // function pluginWin()
});
